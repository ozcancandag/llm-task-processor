graph TB
    subgraph ControlPlane["âš™ï¸ Control Plane"]
        ConfigMgr["ğŸ”§ Config Manager<br/>â”â”â”â”â”â”â”â”â”â”<br/>â€¢ Hot-reload via Pub/Sub<br/>â€¢ 5s local cache TTL<br/>â€¢ Redis + DB fallback"]
        
        RateLimiter["ğŸš¦ Rate Limiter<br/>â”â”â”â”â”â”â”â”â”â”<br/>â€¢ Token bucket per model<br/>â€¢ Lua script (atomic)<br/>â€¢ Configurable capacity"]
        
        MetricsCol["ğŸ“Š Metrics Collector<br/>â”â”â”â”â”â”â”â”â”â”<br/>â€¢ Prometheus client<br/>â€¢ Custom histograms<br/>â€¢ Real-time dashboards"]
    end

    subgraph TaskRouter["ğŸ”€ Task Router Service"]
        RouterLoop["â™¾ï¸ Continuous Loop<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>1. Poll DB (FOR UPDATE SKIP LOCKED)<br/>2. Get config (cached 5s)<br/>3. Select model (weighted random)<br/>4. Push to Redis queue<br/>5. Update status='queued'<br/>6. Sleep 100ms if idle"]
    end

    subgraph Queues["ğŸ“‹ Redis Queues"]
        Q1["queue:gpt-4<br/>â”â”â”â”â”â”â”â”<br/>LPUSH / BRPOP"]
        Q2["queue:claude<br/>â”â”â”â”â”â”â”â”<br/>LPUSH / BRPOP"]
        Q3["queue:gemini<br/>â”â”â”â”â”â”â”â”<br/>LPUSH / BRPOP"]
    end

    subgraph WorkerPools["ğŸ‘· Worker Pools (asyncio)"]
        WP1["âš¡ GPT-4 Pool<br/>â”â”â”â”â”â”â”â”â”â”<br/>Dynamic: 2-20 workers<br/>Rate: 10 req/sec"]
        
        WP2["âš¡ Claude Pool<br/>â”â”â”â”â”â”â”â”â”â”<br/>Dynamic: 2-30 workers<br/>Rate: 20 req/sec"]
        
        WP3["âš¡ Gemini Pool<br/>â”â”â”â”â”â”â”â”â”â”<br/>Dynamic: 2-15 workers<br/>Rate: 15 req/sec"]
    end

    subgraph Backend["ğŸ¤– Models Backend"]
        Single["ğŸ¯ POST /single<br/>Response: 1s - 120s"]
    end

    subgraph Data["ğŸ’¾ PostgreSQL"]
        Tasks[("ğŸ“‹ tasks<br/>status, answer")]
        ModelConfig[("ğŸ”§ model_config<br/>traffic %, limits")]
    end

    subgraph Recovery["ğŸ”§ Recovery Cron Job"]
        RecoveryJob["â° Every 5 minutes<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>1. Find processing > 5min<br/>2. attempts < 3 â†’ reset<br/>3. attempts >= 3 â†’ fail<br/>4. Alert if count > 10"]
    end

    %% Control plane connections
    ConfigMgr -.->|config| TaskRouter
    ConfigMgr -.->|config| WorkerPools

    %% Router connections
    Tasks -.->|poll| TaskRouter
    TaskRouter -->|"LPUSH"| Q1
    TaskRouter -->|"LPUSH"| Q2
    TaskRouter -->|"LPUSH"| Q3

    %% Queue to workers
    Q1 -->|"BRPOP"| WP1
    Q2 -->|"BRPOP"| WP2
    Q3 -->|"BRPOP"| WP3

    %% Rate limiting
    RateLimiter -.->|acquire| WP1
    RateLimiter -.->|acquire| WP2
    RateLimiter -.->|acquire| WP3

    %% Worker to backend
    WP1 -->|"POST"| Single
    WP2 -->|"POST"| Single
    WP3 -->|"POST"| Single

    %% Workers to DB
    WP1 -.->|update| Tasks
    WP2 -.->|update| Tasks
    WP3 -.->|update| Tasks

    %% Metrics
    WP1 -.-> MetricsCol
    WP2 -.-> MetricsCol
    WP3 -.-> MetricsCol

    %% Recovery
    RecoveryJob -->|scan & fix| Tasks
